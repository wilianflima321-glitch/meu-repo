<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CI Metrics Dashboard</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
      h1 { font-size: 20px; }
      .chart { max-width: 900px; }
      table { border-collapse: collapse; margin-top: 12px; width: 100%; }
      th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; }
      th { background: #f6f6f6; }
    </style>
  </head>
  <body>
    <h1>CI Metrics Dashboard</h1>
    <p>Simple static dashboard that reads <code>metrics-archive.json</code> (generated by the scheduled Action) and shows recent health_wait_ms values.</p>

    <div id="content">
      <p>Loading metrics...</p>
    </div>

    <script>
      async function load() {
        try {
          const res = await fetch('../metrics-archive.json');
          if (!res.ok) throw new Error('metrics-archive.json not found');
          const arr = await res.json();
          if (!Array.isArray(arr) || arr.length === 0) {
            document.getElementById('content').innerHTML = '<p>No metrics collected yet.</p>';
            return;
          }

          // sort by created_at descending
          arr.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

          // build table
          let html = '<div class="chart">';
          html += '<table><thead><tr><th>Run</th><th>Created At</th><th>health_wait_ms</th><th>smoke_failures</th></tr></thead><tbody>';
          for (let entry of arr.slice(0,50)) {
            const run = entry.run_number || entry.run_id || '';
            const created = entry.created_at || '';
            const metrics = entry.metrics || {};
            const health = metrics.health_wait_ms || metrics.health_wait_ms_avg || metrics.health_wait_ms_first || '-';
            const smoke = metrics.smoke_failures || 0;
            html += `<tr><td>${run}</td><td>${created}</td><td>${health}</td><td>${smoke}</td></tr>`;
          }
          html += '</tbody></table></div>';
          document.getElementById('content').innerHTML = html;
        } catch (err) {
          document.getElementById('content').innerHTML = '<p style="color:crimson">Error loading metrics: '+err.message+'</p>';
        }
      }
      load();
    </script>
  </body>
</html>
