<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Monaco Editor - AI IDE</title>
    <link rel="stylesheet" href="design-system.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #1e1e1e;
        }

        #layout {
            display: flex;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        #toolbar {
            background: #252526;
            color: white;
            padding: 10px 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid #3e3e42;
        }
        
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 14px;
        }
        
        button:hover {
            background: #1177bb;
        }
        
        select {
            background: #3c3c3c;
            color: white;
            border: 1px solid #3e3e42;
            padding: 8px;
            border-radius: 3px;
        }
        
        #editor-container {
            width: 100%;
            height: calc(100vh - 50px);
        }

        /* Chat dock (direita) */
        #chat-dock {
            width: 360px;
            height: 100%;
            background: #252526;
            border-left: 1px solid #3e3e42;
            display: none;
            flex-direction: column;
        }

        #chat-dock.show {
            display: flex;
        }

        #chat-header {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            color: #ffffff;
            border-bottom: 1px solid #3e3e42;
        }

        #chat-messages {
            flex: 1;
            overflow: auto;
            padding: 12px;
        }

        .chat-msg {
            margin: 0 0 10px 0;
            padding: 10px;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            white-space: pre-wrap;
            color: #d4d4d4;
            background: #1e1e1e;
        }

        .chat-msg.user {
            border-color: #0e639c;
        }

        .chat-msg.assistant {
            border-color: #3e3e42;
        }

        #chat-input-area {
            border-top: 1px solid #3e3e42;
            padding: 10px;
            display: flex;
            gap: 8px;
            background: #252526;
        }

        #chat-input {
            flex: 1;
            resize: none;
            height: 70px;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #3e3e42;
            outline: none;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: inherit;
            font-size: 13px;
        }

        #chat-send {
            white-space: nowrap;
        }
        
        #status {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #007acc;
            color: white;
            padding: 5px 20px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="layout">
        <div style="flex:1; min-width: 0; display:flex; flex-direction:column;">
            <div id="toolbar">
                <button onclick="runCode()">‚ñ∂Ô∏è Run</button>
                <button onclick="formatCode()">üé® Format</button>
                <button onclick="toggleChat(true)">üí¨ Chat</button>
                <button onclick="askAI()">ü§ñ AI Help</button>
                <button onclick="saveCode()">üíæ Save</button>
                <select id="language-select" onchange="changeLanguage()">
                    <option value="typescript">TypeScript</option>
                    <option value="javascript">JavaScript</option>
                    <option value="python">Python</option>
                    <option value="java">Java</option>
                    <option value="go">Go</option>
                    <option value="rust">Rust</option>
                </select>
                <span style="margin-left: auto; font-size: 12px;">
                    Monaco Editor | AI-Powered IDE
                </span>
            </div>

            <div id="editor-container"></div>
        </div>

        <aside id="chat-dock" aria-label="AI Chat">
            <div id="chat-header">
                <span>AI Chat</span>
                <div style="display:flex; gap:8px;">
                    <button onclick="clearChat()" title="Clear">üßπ</button>
                    <button onclick="toggleChat(false)" title="Close">√ó</button>
                </div>
            </div>
            <div id="chat-messages"></div>
            <div id="chat-input-area">
                <textarea id="chat-input" placeholder="Digite sua mensagem... (Enter para enviar, Shift+Enter para quebrar linha)"></textarea>
                <button id="chat-send" onclick="sendChat()">Enviar</button>
            </div>
        </aside>
    </div>
    
    <div id="status">
        Ready | Line 1, Col 1 | UTF-8 | TypeScript
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <script>
        let editor;
        let chatOpen = false;
        const CHAT_STORAGE_KEY = 'aethel_chat_history_v1';
        const chatHistory = [];

        function loadChatHistory() {
            try {
                const raw = localStorage.getItem(CHAT_STORAGE_KEY);
                if (!raw) return;
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed)) {
                    for (const m of parsed) {
                        if (m && (m.role === 'user' || m.role === 'assistant') && typeof m.content === 'string') {
                            chatHistory.push({ role: m.role, content: m.content });
                        }
                    }
                }
            } catch {}
        }

        function persistChatHistory() {
            try {
                localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(chatHistory.slice(-50)));
            } catch {}
        }

        function renderChat() {
            const root = document.getElementById('chat-messages');
            if (!root) return;
            root.innerHTML = '';
            for (const msg of chatHistory) {
                const div = document.createElement('div');
                div.className = `chat-msg ${msg.role}`;
                div.textContent = msg.content;
                root.appendChild(div);
            }
            root.scrollTop = root.scrollHeight;
        }

        function toggleChat(forceOpen) {
            const dock = document.getElementById('chat-dock');
            if (!dock) return;
            chatOpen = typeof forceOpen === 'boolean' ? forceOpen : !chatOpen;
            if (chatOpen) {
                dock.classList.add('show');
                setTimeout(() => {
                    const input = document.getElementById('chat-input');
                    if (input) input.focus();
                    if (editor) editor.layout();
                }, 0);
            } else {
                dock.classList.remove('show');
                if (editor) editor.layout();
            }
        }

        function pushChat(role, content) {
            chatHistory.push({ role, content });
            persistChatHistory();
            renderChat();
        }

        async function sendChat() {
            const inputEl = document.getElementById('chat-input');
            if (!inputEl) return;
            const text = String(inputEl.value || '').trim();
            if (!text) return;

            inputEl.value = '';
            pushChat('user', text);

            const selection = editor ? editor.getSelection() : null;
            const selectedText = (editor && selection) ? editor.getModel().getValueInRange(selection) : '';
            const code = selectedText || (editor ? editor.getValue() : '');
            const prompt = selectedText
                ? `${text}\n\nTrecho selecionado:\n${code}`
                : `${text}\n\nContexto (arquivo atual):\n${code}`;

            try {
                const response = await fetch('/api/agent/coder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input: prompt, workspaceId: 'local', userId: 'local' })
                });
                const result = await response.json().catch(() => ({}));
                if (!response.ok) {
                    throw new Error(result && (result.message || result.error) ? (result.message || result.error) : `HTTP ${response.status}`);
                }
                pushChat('assistant', result.content || 'Sem resposta do agente.');
            } catch (error) {
                pushChat('assistant', '‚ùå Erro ao chamar a IA: ' + (error && error.message ? error.message : String(error)));
            }
        }

        function clearChat() {
            chatHistory.splice(0, chatHistory.length);
            persistChatHistory();
            renderChat();
        }
        
        require.config({ 
            paths: { 
                'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' 
            } 
        });
        
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: `// Welcome to AI IDE with Monaco Editor!
// This is a fully functional code editor with AI assistance

interface User {
    name: string;
    email: string;
}

function validateEmail(email: string): boolean {
    const regex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;
    return regex.test(email);
}

const user: User = {
    name: "Developer",
    email: "dev@ai-ide.com"
};

console.log(\`User: \${user.name}\`);
console.log(\`Email valid: \${validateEmail(user.email)}\`);

// Try pressing Ctrl+Space for AI completions!
// Try pressing Ctrl+S to save
// Try pressing Ctrl+Shift+F to format`,
                language: 'typescript',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: true },
                fontSize: 14,
                lineNumbers: 'on',
                roundedSelection: false,
                scrollBeyondLastLine: false,
                readOnly: false,
                cursorStyle: 'line',
                suggestOnTriggerCharacters: true,
                quickSuggestions: true,
                formatOnPaste: true,
                formatOnType: true,
                tabSize: 2,
            });
            
            // Update status bar
            editor.onDidChangeCursorPosition((e) => {
                const position = editor.getPosition();
                const lang = editor.getModel().getLanguageId();
                document.getElementById('status').textContent = 
                    `Line ${position.lineNumber}, Col ${position.column} | UTF-8 | ${lang}`;
            });
            
            // Keyboard shortcuts
            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, function() {
                saveCode();
            });
            
            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyMod.Shift | monaco.KeyCode.KeyF, function() {
                formatCode();
            });
            
            editor.addCommand(monaco.KeyCode.F5, function() {
                runCode();
            });
            
            // Auto-save every 30 seconds
            setInterval(saveCode, 30000);
            
            // Restore saved code
            const saved = localStorage.getItem('monaco_code');
            const savedLang = localStorage.getItem('monaco_lang');
            if (saved) {
                editor.setValue(saved);
            }
            if (savedLang) {
                document.getElementById('language-select').value = savedLang;
                monaco.editor.setModelLanguage(editor.getModel(), savedLang);
            }

            // Chat init
            loadChatHistory();
            renderChat();

            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChat();
                    }
                });
            }
            
            console.log('Monaco Editor loaded successfully!');
        });
        
        function runCode() {
            // Converte o antigo prompt/alert em chat dock.
            toggleChat(true);
            const selection = editor.getSelection();
            const selectedText = editor.getModel().getValueInRange(selection);
            const inputEl = document.getElementById('chat-input');
            if (inputEl) {
                inputEl.value = selectedText ? 'Explique este trecho e sugira melhorias.' : 'Me ajude com este c√≥digo.';
                inputEl.focus();
            }
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                            input: `${prompt}\n\nCode:\n${code}`,
                            workspaceId: 'local',
                            userId: 'local'
                    })
                });
                
                    const result = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(result && (result.message || result.error) ? (result.message || result.error) : `HTTP ${response.status}`);
                    }
                
                // Show AI response
                const aiResponse = result.content || 'No response from AI';
                alert('ü§ñ AI Response:\\n\\n' + aiResponse.substring(0, 500) + '...');
                
                // Optionally insert AI suggestion
                if (selectedText && confirm('Insert AI suggestion?')) {
                    editor.executeEdits('', [{
                        range: selection,
                        text: aiResponse
                    }]);
                }
            } catch (error) {
                 alert('‚ùå Error calling AI: ' + (error && error.message ? error.message : String(error)));
            }
        }
        
        function changeLanguage() {
            const lang = document.getElementById('language-select').value;
            monaco.editor.setModelLanguage(editor.getModel(), lang);
            localStorage.setItem('monaco_lang', lang);
            
            // Update sample code for language
            const samples = {
                typescript: `// TypeScript Example
interface User {
    name: string;
    age: number;
}

const greet = (user: User): string => {
    return \`Hello, \${user.name}!\`;
};`,
                javascript: `// JavaScript Example
function fibonacci(n) {
    if (n <= 1) return n;
    return fibonacci(n - 1) + fibonacci(n - 2);
}

console.log(fibonacci(10));`,
                python: `# Python Example
def factorial(n):
    if n <= 1:
        return 1
    return n * factorial(n - 1)

print(factorial(5))`,
                java: `// Java Example
public class HelloWorld {
    public static void main(String[] args) {
        System.out.println("Hello, World!");
    }
}`,
                go: `// Go Example
package main

import "fmt"

func main() {
    fmt.Println("Hello, World!")
}`,
                rust: `// Rust Example
fn main() {
    println!("Hello, World!");
}`
            };
            
            if (samples[lang] && confirm('Load sample code for ' + lang + '?')) {
                editor.setValue(samples[lang]);
            }
        }
        
        function saveCode() {
            const code = editor.getValue();
            const lang = editor.getModel().getLanguageId();
            localStorage.setItem('monaco_code', code);
            localStorage.setItem('monaco_lang', lang);
            console.log('‚úÖ Code auto-saved');
        }
    </script>
    
    <!-- Load Core Systems -->
    <script src="icons.js"></script>
    <script src="toast-system.js"></script>
    <script src="tooltip-system.js"></script>
    <script src="theme-toggle.js"></script>
    <script src="undo-redo-system.js"></script>
    <script src="integration-hub.js"></script>
    <script src="ai-context-manager.js"></script>
    <script src="console-panel.js"></script>
    <script src="navbar.js"></script>
    <script src="breadcrumbs.js"></script>
    <script src="file-explorer.js"></script>
    <script src="init.js"></script>
</body>
</html>
