<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Visual Scripting - AI IDE</title>
    <link rel="stylesheet" href="design-system.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reactflow@11.10.1/dist/style.min.css">
    <script src="https://cdn.jsdelivr.net/npm/reactflow@11.10.1/dist/umd/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            overflow: hidden;
        }
        
        #root {
            width: 100vw;
            height: 100vh;
        }
        
        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #1e1e1e;
            color: white;
            padding: 12px 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .toolbar h2 {
            font-size: 18px;
            margin-right: 20px;
        }
        
        .toolbar button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .toolbar button:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .node-library {
            position: fixed;
            left: 0;
            top: 60px;
            width: 240px;
            height: calc(100vh - 60px);
            background: #f7fafc;
            border-right: 1px solid #e2e8f0;
            padding: 15px;
            overflow-y: auto;
            z-index: 100;
        }
        
        .node-library h3 {
            font-size: 14px;
            color: #2d3748;
            margin: 15px 0 10px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .node-library h3:first-child {
            margin-top: 0;
        }
        
        .node-item {
            background: white;
            border: 1px solid #e2e8f0;
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            cursor: grab;
            transition: all 0.2s;
            font-size: 13px;
        }
        
        .node-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
            transform: translateX(2px);
        }
        
        .flow-container {
            margin-left: 240px;
            margin-top: 60px;
            height: calc(100vh - 60px);
            background: #fafafa;
        }
        
        .react-flow__node {
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 12px;
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .react-flow__node-input {
            background: #48bb78;
            border-color: #38a169;
            color: white;
        }
        
        .react-flow__node-output {
            background: #ed8936;
            border-color: #dd6b20;
            color: white;
        }
        
        .node-label {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .node-description {
            font-size: 11px;
            color: #718096;
            margin-top: 5px;
        }
        
        .ai-node {
            border-color: #9f7aea !important;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }
        
        .stats {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 100;
        }
        
        .stats div {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useEffect } = React;
        const ReactFlow = window.ReactFlow.default;
        const { MiniMap, Controls, Background, useNodesState, useEdgesState, addEdge } = window.ReactFlow;

        const nodeTypes = {
            logic: [
                { id: 'if', label: 'If Statement', icon: 'üîÄ', desc: 'Conditional branch' },
                { id: 'loop', label: 'For Loop', icon: 'üîÑ', desc: 'Iterate N times' },
                { id: 'switch', label: 'Switch', icon: 'üéØ', desc: 'Multi-way branch' },
                { id: 'while', label: 'While Loop', icon: 'üîÅ', desc: 'Loop while true' },
            ],
            math: [
                { id: 'add', label: 'Add', icon: '‚ûï', desc: 'A + B' },
                { id: 'multiply', label: 'Multiply', icon: '‚úñÔ∏è', desc: 'A √ó B' },
                { id: 'subtract', label: 'Subtract', icon: '‚ûñ', desc: 'A - B' },
                { id: 'random', label: 'Random', icon: 'üé≤', desc: 'Random number' },
            ],
            game: [
                { id: 'spawn', label: 'Spawn Object', icon: 'üé®', desc: 'Create new object' },
                { id: 'destroy', label: 'Destroy', icon: 'üí•', desc: 'Remove object' },
                { id: 'move', label: 'Move', icon: '‚û°Ô∏è', desc: 'Change position' },
                { id: 'rotate', label: 'Rotate', icon: 'üîÑ', desc: 'Change rotation' },
                { id: 'physics', label: 'Add Physics', icon: '‚ö°', desc: 'Enable physics' },
            ],
            ai: [
                { id: 'ai-generate', label: 'AI Generate', icon: 'ü§ñ', desc: 'AI creates logic' },
                { id: 'ai-optimize', label: 'AI Optimize', icon: '‚ö°', desc: 'AI improves code' },
                { id: 'ai-debug', label: 'AI Debug', icon: 'üîç', desc: 'AI finds bugs' },
            ],
            input: [
                { id: 'keyboard', label: 'Keyboard Input', icon: '‚å®Ô∏è', desc: 'Detect keys' },
                { id: 'mouse', label: 'Mouse Input', icon: 'üñ±Ô∏è', desc: 'Mouse events' },
                { id: 'touch', label: 'Touch Input', icon: 'üëÜ', desc: 'Touch events' },
            ]
        };

        const initialNodes = [
            {
                id: '1',
                type: 'input',
                data: { label: 'üéÆ Start' },
                position: { x: 100, y: 100 },
            },
            {
                id: '2',
                data: { label: <div><div className="node-label">ü§ñ AI Ready</div><div className="node-description">Click "AI Generate" to create nodes</div></div> },
                position: { x: 300, y: 100 },
            },
        ];

        const initialEdges = [
            { id: 'e1-2', source: '1', target: '2', animated: true },
        ];

        function App() {
            const [nodes, setNodes, onNodesChange] = useNodesState(initialNodes);
            const [edges, setEdges, onEdgesChange] = useEdgesState(initialEdges);
            const [showLibrary, setShowLibrary] = useState(true);
            const [nodeCounter, setNodeCounter] = useState(3);

            const onConnect = useCallback(
                (params) => setEdges((eds) => addEdge({ ...params, animated: true }, eds)),
                [setEdges],
            );

            const addNode = (type, label, icon, desc) => {
                const newNode = {
                    id: `node-${nodeCounter}`,
                    data: { 
                        label: (
                            <div>
                                <div className="node-label">{icon} {label}</div>
                                <div className="node-description">{desc}</div>
                            </div>
                        ) 
                    },
                    position: { 
                        x: Math.random() * 400 + 200, 
                        y: Math.random() * 300 + 150 
                    },
                };
                setNodes((nds) => nds.concat(newNode));
                setNodeCounter(prev => prev + 1);
            };

            const generateAINode = async () => {
                const prompt = window.prompt('What should this node do? (e.g., "move player forward when space pressed")');
                if (!prompt) return;

                setNodes((nds) => nds.concat({
                    id: `ai-loading-${Date.now()}`,
                    data: { label: 'ü§ñ AI is thinking...' },
                    position: { x: 300, y: 300 },
                    style: { background: '#edf2f7' }
                }));

                try {
                    const response = await fetch('/api/agent/coder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ input: `Generate visual scripting logic for: ${prompt}` })
                    });

                    const result = await response.json();
                    
                    setNodes((nds) => {
                        const filtered = nds.filter(n => !n.id.startsWith('ai-loading'));
                        return filtered.concat({
                            id: `ai-${Date.now()}`,
                            data: { 
                                label: (
                                    <div className="ai-node">
                                        <div className="node-label">ü§ñ AI Generated</div>
                                        <div style={{fontSize: '11px', marginTop: '5px'}}>{prompt}</div>
                                        <div style={{fontSize: '10px', marginTop: '5px', opacity: 0.8}}>
                                            {result.content.substring(0, 60)}...
                                        </div>
                                    </div>
                                )
                            },
                            position: { x: 300, y: 300 },
                            className: 'ai-node'
                        });
                    });
                } catch (error) {
                    alert('AI generation failed. Using demo response.');
                    setNodes((nds) => {
                        const filtered = nds.filter(n => !n.id.startsWith('ai-loading'));
                        return filtered.concat({
                            id: `ai-${Date.now()}`,
                            data: { 
                                label: (
                                    <div className="ai-node">
                                        <div className="node-label">ü§ñ AI Generated</div>
                                        <div style={{fontSize: '11px', marginTop: '5px'}}>{prompt}</div>
                                        <div style={{fontSize: '10px', marginTop: '5px', opacity: 0.8}}>
                                            // Demo: Player movement logic
                                        </div>
                                    </div>
                                )
                            },
                            position: { x: 300, y: 300 },
                        });
                    });
                }
            };

            const compileBlueprint = () => {
                let code = '// Compiled Visual Script\n\n';
                
                nodes.forEach((node, index) => {
                    const label = typeof node.data.label === 'string' ? node.data.label : 'Custom Node';
                    code += `// Node ${index + 1}: ${label}\n`;
                    code += `function node_${node.id.replace('-', '_')}() {\n`;
                    code += `    // Logic here\n`;
                    code += `}\n\n`;
                });

                edges.forEach((edge, index) => {
                    code += `// Connection ${index + 1}: ${edge.source} -> ${edge.target}\n`;
                });

                console.log(code);
                alert('Blueprint compiled! Check browser console for generated code.');
            };

            const clearAll = () => {
                if (confirm('Clear all nodes?')) {
                    setNodes(initialNodes);
                    setEdges(initialEdges);
                    setNodeCounter(3);
                }
            };

            return (
                <div>
                    <div className="toolbar">
                        <h2>üé® Visual Scripting</h2>
                        <button onClick={() => setShowLibrary(!showLibrary)}>
                            {showLibrary ? 'üìö Hide Library' : 'üìö Show Library'}
                        </button>
                        <button onClick={compileBlueprint}>‚öôÔ∏è Compile to Code</button>
                        <button onClick={generateAINode}>ü§ñ AI Generate Node</button>
                        <button onClick={clearAll}>üóëÔ∏è Clear All</button>
                    </div>

                    {showLibrary && (
                        <div className="node-library">
                            {Object.entries(nodeTypes).map(([category, items]) => (
                                <div key={category}>
                                    <h3>{category}</h3>
                                    {items.map(item => (
                                        <div 
                                            key={item.id}
                                            className="node-item"
                                            onClick={() => addNode(item.id, item.label, item.icon, item.desc)}
                                        >
                                            {item.icon} {item.label}
                                        </div>
                                    ))}
                                </div>
                            ))}
                        </div>
                    )}

                    <div className="flow-container">
                        <ReactFlow
                            nodes={nodes}
                            edges={edges}
                            onNodesChange={onNodesChange}
                            onEdgesChange={onEdgesChange}
                            onConnect={onConnect}
                            fitView
                        >
                            <Controls />
                            <MiniMap />
                            <Background variant="dots" gap={16} size={1} color="#cbd5e0" />
                        </ReactFlow>
                    </div>

                    <div className="stats">
                        <div>üìä <strong>Nodes:</strong> {nodes.length}</div>
                        <div>üîó <strong>Connections:</strong> {edges.length}</div>
                        <div>üí° <strong>Tip:</strong> Drag nodes to connect them</div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <!-- Load Core Systems -->
    <script src="icons.js"></script>
    <script src="toast-system.js"></script>
    <script src="tooltip-system.js"></script>
    <script src="theme-toggle.js"></script>
    <script src="undo-redo-system.js"></script>
    <script src="integration-hub.js"></script>
    <script src="ai-context-manager.js"></script>
    <script src="console-panel.js"></script>
    <script src="navbar.js"></script>
    <script src="breadcrumbs.js"></script>
    <script src="file-explorer.js"></script>
    <script src="init.js"></script>
</body>
</html>
