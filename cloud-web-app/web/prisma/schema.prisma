// Prisma Schema for Cloud Web App
// Database: PostgreSQL

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id               String  @id @default(cuid())
  email            String  @unique
  password         String
  name             String?
  avatar           String?
  // Role do usuário (user|admin|super_admin). RBAC completo pode evoluir depois.
  role             String  @default("user")
  // Plano atual (ex: starter/basic/pro/studio/enterprise). Trial usa sufixo "_trial" (ex: starter_trial).
  plan             String  @default("starter_trial")
  stripeCustomerId String? @unique
  
  // OAuth fields
  oauthProvider    String?
  oauthProviderId  String?
  
  // Email verification
  emailVerified          Boolean   @default(false)
  verificationToken      String?
  verificationTokenExpiry DateTime?
  
  // Password reset
  resetToken             String?
  resetTokenExpiry       DateTime?

  // Shadow Ban System - usuário continua "usando" mas sem impacto real
  isShadowBanned    Boolean   @default(false)
  shadowBanReason   String?
  shadowBannedAt    DateTime?
  shadowBannedBy    String?   // ID do admin que aplicou
  
  // Multi-Factor Authentication
  mfaEnabled        Boolean   @default(false)
  mfaSecret         String?   // TOTP secret (encrypted)
  mfaBackupCodes    String?   // JSON array of hashed backup codes
  
  // Admin-specific fields
  adminRole         String?   // owner|super_admin|admin|moderator|support
  adminPermissions  String?   // JSON array de permissões customizadas
  lastAdminAction   DateTime?

  projects Project[]
  projectMemberships ProjectMember[]
  sessions Session[]

  chatThreads ChatThread[]
  copilotWorkflows CopilotWorkflow[]

  usageBuckets      UsageBucket[]
  concurrencyLeases ConcurrencyLease[]

  creditLedgerEntries CreditLedgerEntry[]
  auditLogs           AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([role])
  @@index([isShadowBanned])
  @@index([adminRole])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

// ============================================
// PROJECTS
// ============================================

model Project {
  id       String  @id @default(cuid())
  name     String
  template String? // platformer2d, fps3d, etc

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  files  File[]
  assets Asset[]

  members ProjectMember[]

  chatThreads ChatThread[]
  copilotWorkflows CopilotWorkflow[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
}

model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Roles: viewer|editor. Owner é o Project.userId.
  role String @default("viewer")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@index([role])
}

// ============================================
// CHAT (PERSISTENTE POR CONTA)
// ============================================

model ChatThread {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Opcional: amarra a um projeto (threads por workspace).
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  title     String  @default("Chat")
  archived  Boolean @default(false)

  messages ChatMessage[]

  workflow CopilotWorkflow?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([projectId])
  @@index([updatedAt])
}

// ============================================
// COPILOT WORKFLOWS (FLUXO DE TRABALHO PERSISTENTE)
// ============================================

model CopilotWorkflow {
  id        String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Workflow pode estar ligado a um chat (1:1 opcional).
  chatThreadId String? @unique
  chatThread   ChatThread? @relation(fields: [chatThreadId], references: [id], onDelete: SetNull)

  title   String  @default("Workflow")
  archived Boolean @default(false)

  // Snapshot de contexto (seleções, live preview, arquivos abertos, etc)
  context Json?
  contextVersion Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastUsedAt DateTime @default(now())

  @@index([userId])
  @@index([projectId])
  @@index([archived])
  @@index([lastUsedAt])
}

model ChatMessage {
  id       String @id @default(cuid())
  threadId String
  thread   ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  role    String // user|assistant|system
  content String @db.Text
  model   String?
  metadata Json?

  createdAt DateTime @default(now())

  @@index([threadId])
  @@index([createdAt])
}

// ============================================
// FILES
// ============================================

model File {
  id       String  @id @default(cuid())
  path     String // /src/main.js
  content  String  @db.Text
  language String? // javascript, typescript, python, etc

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, path])
  @@index([projectId])
}

// ============================================
// ASSETS - Game Engine Assets (Textures, Models, Audio, etc)
// ============================================

model Asset {
  id          String  @id @default(cuid())
  name        String
  type        String  // mesh, texture, material, audio, video, blueprint, animation, prefab, level, script, other
  extension   String  @default("")
  path        String  // Virtual path: /Content/Characters/Hero.fbx
  storagePath String? // S3 key: projects/{projectId}/Content/{assetId}/Hero.fbx
  url         String? // Public CDN URL (if applicable)
  
  size        Int     @default(0) // bytes
  mimeType    String?
  thumbnail   String? // Thumbnail URL/path
  
  // Extended metadata (vertices, triangles, duration, dimensions, etc)
  metadata    Json?
  tags        String[] @default([])
  
  // Status tracking for async uploads
  status      String  @default("ready") // pending, ready, processing, failed, deleted
  
  // Favorites for quick access
  isFavorite  Boolean @default(false)
  
  // Upload tracking
  uploaderId  String?
  
  projectId   String
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([projectId, path])
  @@index([projectId, type])
  @@index([projectId, status])
  @@index([projectId, isFavorite])
  @@index([uploaderId])
}

// ============================================
// FOLDERS - Virtual folder structure for assets
// ============================================

model Folder {
  id          String  @id @default(cuid())
  name        String
  path        String  // Full path: /Content/Characters
  parentPath  String  // Parent path: /Content
  color       String? // Custom folder color
  
  projectId   String
  createdById String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([projectId, path])
  @@index([projectId])
  @@index([projectId, parentPath])
}

// ============================================
// BILLING
// ============================================

model Subscription {
  id                   String   @id @default(cuid())
  userId               String   @unique
  stripeSubscriptionId String   @unique
  stripePriceId        String
  status               String // active, canceled, past_due
  currentPeriodEnd     DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model Payment {
  id              String @id @default(cuid())
  userId          String
  stripePaymentId String @unique
  amount          Int // cents
  currency        String @default("usd")
  status          String // succeeded, failed, pending

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([status])
}

// ============================================
// WALLET / CREDITS LEDGER
// ============================================

model CreditLedgerEntry {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Quantidade de créditos (inteiro). Negativo = débito, positivo = crédito.
  amount    Int
  currency  String   @default("credits")
  entryType String
  reference String?
  metadata  Json?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([entryType])
}

// ============================================
// MARKETPLACE
// ============================================

model MarketplaceItem {
  id          String @id @default(cuid())
  title       String
  description String @db.Text
  price       Int // cents, 0 for free
  category    String // template, asset, plugin
  authorId    String
  downloads   Int    @default(0)
  rating      Float  @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([authorId])
}

model InstalledExtension {
  id          String   @id @default(cuid())
  userId      String
  extensionId String
  projectId   String?

  // Mantém sem FK para Project por enquanto (podemos evoluir depois)
  createdAt DateTime @default(now())

  @@unique([userId, extensionId])
  @@index([userId])
  @@index([extensionId])
  @@index([projectId])
}

// ============================================
// ADMIN
// ============================================

model AuditLog {
  id       String  @id @default(cuid())
  userId   String?
  action   String // login, create_project, delete_file, etc
  resource String? // project_id, file_id, etc
  metadata Json?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// ============================================
// METERING / RATE LIMITING (PER USER)
// ============================================

model UsageBucket {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Janela de agregação (hour/day/month) em UTC
  window      String
  windowStart DateTime
  windowEnd   DateTime

  requests Int @default(0)
  tokens   Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, window, windowStart])
  @@index([userId, window, windowStart])
  @@index([window, windowStart])
}

model ConcurrencyLease {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Identifica a operação/rota que adquiriu o lease (diagnóstico)
  key       String
  expiresAt DateTime

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id       String  @id @default(cuid())
  userId   String
  type     String  // info, success, warning, error, system
  title    String
  message  String?
  data     Json?
  read     Boolean @default(false)
  
  createdAt DateTime @default(now())
  readAt    DateTime?

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

// ============================================
// FEATURE FLAGS
// ============================================

model FeatureFlag {
  id          String  @id @default(cuid())
  key         String  @unique
  name        String
  description String?
  type        String  @default("boolean") // boolean, percentage, variant, rule_based
  enabled     Boolean @default(true)
  
  // Configuração por tipo
  percentage   Int?
  variants     Json?
  rules        Json?
  environments Json?
  
  // Targeting
  allowedUsers String[]
  blockedUsers String[]
  
  // Metadata
  tags      String[]
  createdBy String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([enabled])
}

// ============================================
// BACKUPS
// ============================================

model Backup {
  id          String  @id @default(cuid())
  projectId   String
  type        String  @default("manual") // manual, auto, scheduled
  description String?
  
  // Snapshot info
  filesCount  Int     @default(0)
  assetsCount Int     @default(0)
  size        Int     @default(0) // bytes
  storageUrl  String? // URL do backup no storage
  
  // Status
  status      String  @default("pending") // pending, completed, failed
  
  createdBy   String
  createdAt   DateTime @default(now())
  completedAt DateTime?

  @@index([projectId])
  @@index([createdBy])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// COLLABORATION ROOMS
// ============================================

model CollaborationRoom {
  id              String   @id @default(cuid())
  name            String
  type            String   @default("project") // project, file, voice
  projectId       String?
  fileId          String?
  maxParticipants Int?
  
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  participants CollaborationRoomParticipant[]

  @@index([projectId])
  @@index([createdBy])
}

model CollaborationRoomParticipant {
  id        String   @id @default(cuid())
  roomId    String
  room      CollaborationRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  userId String

  status   String   @default("online") // online, away, offline
  lastSeen DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([roomId, userId])
  @@index([roomId])
  @@index([userId])
  @@index([status])
  @@index([lastSeen])
}

// ============================================
// ANALYTICS EVENTS
// ============================================

model AnalyticsEvent {
  id         String   @id @default(cuid())
  userId     String?
  sessionId  String?
  event      String
  category   String?
  properties Json?
  
  // Context
  projectId  String?
  url        String?
  userAgent  String?
  ip         String?
  
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([event])
  @@index([category])
  @@index([projectId])
  @@index([createdAt])
}

// ============================================
// AUDIT LOG - Admin Actions Tracking
// ============================================

model AuditLog {
  id          String   @id @default(cuid())
  
  // Who performed the action
  adminId     String
  admin       User     @relation(fields: [adminId], references: [id])
  adminEmail  String   // Snapshot para histórico
  adminRole   String   // Snapshot do role no momento da ação
  
  // What action was performed
  action      String   // shadow_ban, emergency_activate, user_delete, etc.
  category    String   // moderation, finance, security, system
  severity    String   @default("info") // info, warning, critical
  
  // Target of the action
  targetType  String?  // user, project, system, ai_agent
  targetId    String?  // ID do alvo (userId, projectId, etc)
  targetEmail String?  // Email do usuário alvo (se aplicável)
  
  // Details
  reason      String?  // Motivo da ação
  metadata    Json?    // Dados extras (old value, new value, etc)
  
  // Request context
  ipAddress   String?
  userAgent   String?
  requestId   String?  // Para correlacionar logs
  
  createdAt   DateTime @default(now())

  @@index([adminId])
  @@index([action])
  @@index([category])
  @@index([severity])
  @@index([targetId])
  @@index([targetType])
  @@index([createdAt])
}

// ============================================
// EMERGENCY MODE STATE
// ============================================

model EmergencyState {
  id              String   @id @default("singleton")
  
  level           String   @default("normal") // normal, warning, critical, shutdown
  reason          String?
  activatedBy     String?  // Admin ID
  activatedAt     DateTime?
  
  // Budget tracking
  dailyBudget     Float    @default(1000)
  hourlyBudget    Float    @default(100)
  monthlyBudget   Float    @default(25000)
  currentDailySpend   Float @default(0)
  currentHourlySpend  Float @default(0)
  currentMonthlySpend Float @default(0)
  
  // Model restrictions during emergency
  allowedModels   String?  // JSON array of allowed model IDs
  maxTokensPerRequest Int  @default(4096)
  
  // Notification settings
  webhookUrl      String?
  alertEmails     String?  // JSON array of emails
  
  lastResetDaily  DateTime @default(now())
  lastResetHourly DateTime @default(now())
  lastResetMonthly DateTime @default(now())
  
  updatedAt       DateTime @updatedAt
}

// ============================================
// MODERATION QUEUE
// ============================================

model ModerationItem {
  id          String   @id @default(cuid())
  
  // Type of content being moderated
  type        String   // user_report, ai_output, project_content, asset
  status      String   @default("pending") // pending, approved, rejected, escalated
  priority    String   @default("normal") // low, normal, high, urgent
  
  // Reporter (if user-reported)
  reporterId  String?
  reporterEmail String?
  
  // Target content
  targetType  String   // user, project, asset, ai_generation
  targetId    String
  targetOwnerId String?
  
  // Content snapshot (para não depender do original)
  contentSnapshot Json?
  
  // Moderation details
  reason      String?
  category    String?  // spam, abuse, inappropriate, copyright, other
  notes       String?  // Notas do moderador
  
  // Resolution
  resolvedBy  String?  // Admin ID
  resolvedAt  DateTime?
  resolution  String?  // Ação tomada
  
  // Auto-detection scores (se aplicável)
  autoScore   Float?   // 0-1 confidence de violação
  autoFlags   String?  // JSON array of detected issues
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([priority])
  @@index([type])
  @@index([targetId])
  @@index([createdAt])
}

// ============================================
// LIVE SESSIONS (God View)
// ============================================

model LiveSession {
  id          String   @id @default(cuid())
  
  userId      String
  userEmail   String   // Snapshot
  userName    String?  // Snapshot
  
  projectId   String?
  projectName String?  // Snapshot
  
  // Connection info
  socketId    String?  @unique
  ipAddress   String?
  userAgent   String?
  country     String?  // GeoIP
  city        String?  // GeoIP
  
  // Activity tracking
  currentPage String?  // Página/view atual
  currentTool String?  // Ferramenta ativa no editor
  lastAction  String?  // Última ação
  
  // AI usage in session
  aiCallsCount    Int   @default(0)
  aiTokensUsed    Int   @default(0)
  aiCostIncurred  Float @default(0)
  
  // Timing
  startedAt   DateTime @default(now())
  lastPingAt  DateTime @default(now())
  endedAt     DateTime?
  
  // Status
  isActive    Boolean  @default(true)
  
  @@index([userId])
  @@index([projectId])
  @@index([isActive])
  @@index([startedAt])
  @@index([lastPingAt])
}
