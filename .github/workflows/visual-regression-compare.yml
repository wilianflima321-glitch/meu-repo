name: Visual Regression - Compare vs Baseline

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: {}

permissions:
  contents: read
  issues: write

jobs:
  compare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install deps
        run: |
          # Use npm ci when a lockfile exists for reproducible installs,
          # otherwise fall back to npm install in this repo (no lockfile).
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --no-audit --no-fund
          fi

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Fetch visual-baseline branch
        run: |
          # Attempt to fetch the baseline branch if it exists; don't fail if it doesn't.
          git fetch origin visual-baseline:visual-baseline || echo 'no baseline branch'

      - name: (fallback) Start static server for capture
        if: always()
        run: |
          # In case the project does not expose a live dev server on 3000 in CI,
          # serve the bundled test_site so capture_baseline can fetch pages.
          python3 -m http.server 3000 --directory tools/ide/ui-audit/test_site > /dev/null 2>&1 &
          echo "Static test site started"

      - name: Capture current screenshots
        run: |
          node tools/ide/visual-regression/capture_baseline.js --baseUrl http://localhost:3000 --out tools/ide/visual-regression/output/current || true

      - name: Restore baseline (if present)
        run: |
          # Try to restore committed baseline from the visual-baseline branch.
          # If the baseline output doesn't exist after the checkout, skip gracefully.
          if git rev-parse --verify visual-baseline >/dev/null 2>&1; then
            git checkout visual-baseline -- tools/ide/visual-regression/output/baseline || true
            git checkout visual-baseline -- tools/ide/visual-regression/baseline || true
            if [ -d "tools/ide/visual-regression/output/baseline" ]; then
              mkdir -p tools/ide/visual-regression/baseline || true
              cp -r tools/ide/visual-regression/output/baseline/* tools/ide/visual-regression/baseline/ 2>/dev/null || true
            fi
            if [ -d "tools/ide/visual-regression/baseline" ]; then
              echo 'Baseline restored'
            else
              echo 'baseline directory not present after checkout; skipping compare'
            fi
          else
            echo 'No baseline branch to compare against; skipping restore'
          fi

      - name: Compare baseline vs current
        run: |
          # Only run compare if baseline directory exists; otherwise skip with notice.
          if [ -d "tools/ide/visual-regression/baseline" ]; then
            node tools/ide/visual-regression/compare_baseline.js --baseline tools/ide/visual-regression/baseline --current tools/ide/visual-regression/output/current --out tools/ide/visual-regression/output/diffs --per 100 --total 500 || echo 'compare exit code indicates diffs'
          else
            echo 'No baseline present; skipping compare step'
          fi

      - name: Upload diffs
        uses: actions/upload-artifact@v4
        with:
          name: visual-diffs
          path: tools/ide/visual-regression/output/diffs

      - name: Check report and create issue if regressions
        if: ${{ secrets.GH_PAT != '' }}
        uses: actions/github-script@v6
        with:
          # Prefer a repo secret PAT for creating issues (secrets.GH_PAT).
          # When running from forks/sealed contexts the secret will be empty and this step will be skipped.
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const fs = require('fs');
            const reportPath = 'tools/ide/visual-regression/output/diffs/compare-report.json';
            if (!fs.existsSync(reportPath)) { core.notice('No compare report'); return }
            const report = JSON.parse(fs.readFileSync(reportPath,'utf8'));
            const total = report.totalDiff || 0;
            if (total > 500) {
              const body = `Visual regression detected: total differing pixels = ${total}. See artifacts attached to the workflow run.`;
              await github.rest.issues.create({ owner: context.repo.owner, repo: context.repo.repo, title: 'Visual regression detected', body });
              core.setFailed('Visual regression threshold exceeded');
            } else {
              core.info(`Total diff pixels: ${total}`);
            }
