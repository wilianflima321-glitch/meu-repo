name: Visual Regression - Compare vs Baseline

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: {}

concurrency:
  group: visual-regression-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write

jobs:
  compare:
    runs-on: ubuntu-latest
    env:
      BASE_URL: http://localhost:3000
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: cloud-web-app/web/package-lock.json

      - name: Install root deps
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --no-audit --no-fund
          fi

      - name: Install web deps
        run: |
          npm --prefix cloud-web-app/web ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Interface gate (pre-compare)
        run: npm --prefix cloud-web-app/web run qa:interface-gate

      - name: Canonical component gate (pre-compare)
        run: npm --prefix cloud-web-app/web run qa:canonical-components

      - name: Route contracts gate (pre-compare)
        run: npm --prefix cloud-web-app/web run qa:route-contracts

      - name: Anti fake-success gate (pre-compare)
        run: npm --prefix cloud-web-app/web run qa:no-fake-success

      - name: Encoding sweep gate (pre-compare)
        run: npm --prefix cloud-web-app/web run qa:mojibake

      - name: Start server (web app with static fallback)
        run: |
          check_ready() {
            for i in $(seq 1 45); do
              if curl -fsS "$BASE_URL" >/dev/null; then
                return 0
              fi
              sleep 1
            done
            return 1
          }

          npm run portal:dev > /tmp/portal-dev.log 2>&1 &

          if check_ready; then
            echo "Web app is online at $BASE_URL"
            exit 0
          fi

          echo "Web app did not start in time; switching to static test site."
          node tools/ide/ui-audit/static_server.js > /tmp/static-server.log 2>&1 &
          if ! check_ready; then
            echo "Static fallback did not become ready."
            echo "--- portal-dev.log (tail) ---"
            tail -n 80 /tmp/portal-dev.log || true
            echo "--- static-server.log (tail) ---"
            tail -n 80 /tmp/static-server.log || true
            exit 1
          fi

      - name: Fetch visual-baseline branch
        run: |
          # Attempt to fetch the baseline branch if it exists; don't fail if it doesn't.
          git fetch origin visual-baseline:visual-baseline || echo 'no baseline branch'

      - name: Capture current screenshots
        run: |
          node tools/ide/visual-regression/capture_baseline.js --baseUrl "$BASE_URL" --out tools/ide/visual-regression/output/current

      - name: Restore baseline (if present)
        run: |
          # Try to restore committed baseline from the visual-baseline branch.
          # If the baseline output doesn't exist after the checkout, skip gracefully.
          if git rev-parse --verify visual-baseline >/dev/null 2>&1; then
            git checkout visual-baseline -- tools/ide/visual-regression/output/baseline || true
            git checkout visual-baseline -- tools/ide/visual-regression/baseline || true
            if [ -d "tools/ide/visual-regression/output/baseline" ]; then
              mkdir -p tools/ide/visual-regression/baseline || true
              cp -r tools/ide/visual-regression/output/baseline/* tools/ide/visual-regression/baseline/ 2>/dev/null || true
            fi
            if [ -d "tools/ide/visual-regression/baseline" ]; then
              echo 'Baseline restored'
            else
              echo 'baseline directory not present after checkout; skipping compare'
            fi
          else
            echo 'No baseline branch to compare against; skipping restore'
          fi

      - name: Compare baseline vs current
        run: |
          # Only run compare if baseline directory exists; otherwise skip with notice.
          if [ -d "tools/ide/visual-regression/baseline" ]; then
            node tools/ide/visual-regression/compare_baseline.js --baseline tools/ide/visual-regression/baseline --current tools/ide/visual-regression/output/current --out tools/ide/visual-regression/output/diffs --per 50 --total 100
          else
            echo 'No baseline present; skipping compare step'
          fi

      - name: Upload diffs
        if: always()
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: visual-diffs
          path: |
            tools/ide/visual-regression/output/current
            tools/ide/visual-regression/output/diffs
            /tmp/portal-dev.log
            /tmp/static-server.log

      - name: Check report and create issue if regressions
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require('fs');
            const reportPath = 'tools/ide/visual-regression/output/diffs/compare-report.json';
            if (!fs.existsSync(reportPath)) { core.notice('No compare report'); return }
            const report = JSON.parse(fs.readFileSync(reportPath,'utf8'));
            const total = report.totalDiff || 0;
            if (total > 100) {
              const body = `Visual regression detected: total differing pixels = ${total}. See artifacts attached to the workflow run.`;
              try {
                await github.rest.issues.create({ owner: context.repo.owner, repo: context.repo.repo, title: 'Visual regression detected', body });
                core.info('Opened regression issue for visibility.');
              } catch (error) {
                core.warning(`Unable to create issue: ${error.message}`);
              }
              core.setFailed('Visual regression threshold exceeded');
            } else {
              core.info(`Total diff pixels: ${total}`);
            }
